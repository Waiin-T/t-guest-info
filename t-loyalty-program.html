<dom-module id="t-loyalty-program">
    <template>
    <style>
       :host {
        display: block;
      }

      paper-dropdown-menu {
        --paper-input-container-underline-focus: #4CB050;
        --paper-input-container-focus-color: #4CB050;
        --paper-input-container-label-focus: lightgray;
      }

      paper-input {
        --paper-input-container-underline-focus: #4CB050;
        --paper-input-container-focus-color: #4CB050;
        --paper-input-container-label-focus: lightgray;
      }

      @media (min-width: 320px) and (max-width:380px) {
       .guestName {
        width: 45%;
        margin-left: -5px;
      }

      .programName {
        width: 45%;
        margin-left: 11px;
      }

      .programNumber {
        width: 45%;
        margin-left: -5px;
      }

      #buttonRemove {
        margin-left: 10px;
        margin-top: 20px;
        width: 60px;
        color: var(--color-for-button-labels);
        font-weight: 450;
        text-transform: capitalize;
      }
       #addProgramForOtherGuestButton {
        color: var(--color-for-button-labels);
        margin-left: -13px;
        float: left;
        margin-top: 3%;
        padding-bottom: 30px;
        text-transform: capitalize;
      }
      }
      
      @media (min-width: 380px) and (max-width:767px) {
      .guestName {
        width: 45%;
        margin-left: -5px;
      }

      .programName {
        width: 45%;
        margin-left: 11px;
      }

      .programNumber {
        width: 45%;
        margin-left: -5px;
      }

       #buttonRemove {
        margin-left: 15px;
        margin-top: 6%;
        width: 60px;
        color: var(--color-for-button-labels);
        font-weight: 450;
        text-transform: capitalize;
      }

      #addProgramForOtherGuestButton {
        color: var(--color-for-button-labels);
        margin-left: -9px;
        float: left;
        margin-top: 3%;
        padding-bottom: 30px;
        text-transform: capitalize;
      }
      }

      @media (min-width: 768px) and (max-width:1023px) {
      .guestName {
        width: 22%;
      }

      .programName {
        width: 22%;
      }

      .programNumber {
        width: 22%;
        margin-left: 10px;
      }
      #buttonRemove {
        margin-top: 5%;
        margin-left: 20px;
        width: 60px;
        color: var(--color-for-button-labels);
        font-weight: 450;
        text-transform: capitalize;
      }
      #addProgramForOtherGuestButton {
        color: var(--color-for-button-labels);
        float: left;
        margin-top: 3%;
        padding-bottom: 30px;
        text-transform: capitalize;
      }
      }

      @media (min-width: 1024px){
      .guestName {
        width: 23%;
        margin-left: 10px;
      }

      .programName {
        width: 23%;
        margin-left: 25px;
      }

      .programNumber {
        width: 23%;
        margin-left: 25px;
      }
       #addProgramForOtherGuestButton {
        color: var(--color-for-button-labels);
        margin-left: 6px;
        float: left;
        margin-top: 3%;
        padding-bottom: 30px;
        text-transform: capitalize;
      }
       #buttonRemove {
        margin-top: 4%;
        margin-left: 65px;
        width: 60px;
        color: var(--color-for-button-labels);
        font-weight: 450;
        text-transform: capitalize;
      }
      }


      .guestName,
      .programName,
      .programNumber,
      #buttonRemove {
        float: left;
      }

     

      #guestNameError {
      font-size: var(--paper-font-caption_-_font-size);
                /* margin-top: -6px;
                margin-left: 1px;
                position: absolute; */
                color: var(--paper-deep-orange-a700);
      }
      .item {
        clear: both;
      }
    </style>
     <iron-media-query query="(max-width: 380px)" query-matches="{{smallMobileView}}"></iron-media-query>
    <iron-media-query query="(min-width: 380px) and (max-width:767px)" query-matches="{{mobileView}}"></iron-media-query>
    <iron-media-query query="(min-width: 768px) and (max-width:1023px)" query-matches="{{tabletView}}"></iron-media-query>
    <iron-media-query query="(min-width: 1024px) and (max-width: 1200px)" query-matches="{{desktopView}}"></iron-media-query>
    <iron-media-query query="(min-width: 1200px)" query-matches="{{largeDesktopView}}"></iron-media-query> 

    <!-- <div class="item" smallMobileView$="{{smallMobileView}}" desktopView$="{{desktopView}}" tabletView$="{{tabletView}}" mobileView$="{{mobileView}}"> -->
        <div id="contentDiv">
            
        <template is="dom-repeat" items="{{_loyaltyPrograms}}" index-as="loyaltyProgramNumber" id="loyaltyTemp">
        <div style="clear:both" id="div{{loyaltyProgramNumber}}">
          <div class="guestName" id="guestNameDiv">
            <paper-dropdown-menu label="{{_guestName}}" id="guestName{{loyaltyProgramNumber}}" on-tap="_updatePaxList" required auto-validate>
                <paper-listbox slot="dropdown-content" selected="{{_guestNameValue}}">
                    <template is="dom-repeat" items={{_tempPaxArray}}>
                        <paper-item id="{{loyaltyProgramNumber}}" on-tap="_showGuestProgramDetails">{{item.firstName}}&nbsp{{item.lastName}}</paper-item>
                    </template>
    </paper-listbox>
    </paper-dropdown-menu>
    <input is="iron-input" type="hidden" bind-value="[[_guestNameValue]]">
    <div id="guestNameError" hidden$="{{_showGuestNameError}}">{{_guestNameError}}</div>
    </div>
    <div hidden$="{{_showProgramNameInput}}">
        <paper-input label="{{_programName}}" id="programNameInput{{loyaltyProgramNumber}}" class="programName" required></paper-input>
    </div>
    <div hidden$="{{_showProgramNameDropdown}}">
        <paper-dropdown-menu label="{{_programName}}" id="programName{{loyaltyProgramNumber}}" class="programName" required auto-validate>
            <paper-listbox slot="dropdown-content" selected="{{_programNameValue}}">
                <template is="dom-repeat" items={{paxList}}>
                  <paper-item>{{item.membership.programName}}</paper-item>
                </template>
            </paper-listbox>
        </paper-dropdown-menu>
        <input is="iron-input" type="hidden" bind-value="[[_programNameValue]]">
    </div>
    <div>
        <paper-input label="{{_programNumber}}" id="programNumber{{loyaltyProgramNumber}}" class="programNumber" on-click="_showValidation" required auto-validate></paper-input>
    </div>
    <div id="buttonRemoveDiv" hidden$=[[_isRemoveButtonHidden]]>
        <paper-button id="buttonRemove" on-tap="_deleteLoyaltyProgram" class$="c{{loyaltyProgramNumber}}">{{_remove}}</paper-button>
    </div>
    </div>
    </template>

    </div>
    <br />
    <!-- <div> -->

    <paper-button id="addProgramForOtherGuestButton" on-tap="_addProgramForOtherGuest">{{_addNewGuest}}</paper-button>

    <!-- </div> -->
    <!-- </div> -->
    </template>


    <script>
        /**
         * `t-loyalty-program`
         * 
         *
         * @customElement
         * @polymer
         * @demo demo/index.html
         */
        class TLoyaltyProgram extends Polymer.Element {
            static get is() {
                return 't-loyalty-program';
            }
            static get properties() {
                    return {
                        _showGuestNameError: {
                            type: Boolean,
                            value: true
                        },
                        /**
                         * @private
                         *Array for Loyalty Program. 
                         **/
                        _loyaltyPrograms: {
                            type: Array,
                            notify: true,
                            value: []
                        },
                        /**
                         * @private
                         * Property to hide remove button when loyalty program is only one.
                         * */
                        _isRemoveButtonHidden: {
                            type: Boolean,
                            computed: '_lte(_loyaltyProgramsCount , 1)'
                        },
                        /**
                         * @private
                         * Selected value for guest name dropdown.
                         * */
                        _guestNameValue: {
                            type: String
                        },
                        /**
                         * @private
                         * Selected value for program name
                         * */
                        _programNameValue: {
                            type: String
                        },
                        /**
                         * @private
                         * used for iron media query
                         * */
                        smallMobileView: {
                            type: Boolean,
                            value: false
                        },
                        /**
                         * @private
                         * used for iron media query
                         * */
                        mobileView: {
                            type: Boolean,
                            value: false
                        },
                        /**
                         * @private
                         * used for iron media query
                         * */
                        tabletView: {
                            type: Boolean,
                            value: false
                        },
                        /**
                         * @private
                         * used for iron media query
                         * */
                        desktopView: {
                            type: Boolean,
                            value: false
                        },
                        /**
                         * @private
                         * used for iron media query
                         * */
                        largeDesktopView: {
                            type: Boolean,
                            value: false
                        },
                        /**
                         * Used for paxlist
                         * */
                        paxList: {
                            type: Object,
                        },
                        /**
                         * @private
                         * This property is used for Loyalty program count.
                         * */
                        _loyaltyProgramsCount: {
                            type: Number,
                            value: ''
                        },
                        /**
                         * This property set to false if paxlist is not available.
                         * */
                        paxListAvailable: {
                            type: Boolean
                        },
                        /**
                         * @private
                         * To store temporary paxlist for dropdown.
                         * */
                        _tempPaxArray: {
                            type: Array,
                            value: []
                        },
                        /**
                         * @private
                         * This is true if paxlist is not available.
                         * */
                        _showProgramNameInput: {
                            type: Boolean,
                            value: true
                        },
                        /**
                         * @private
                         * This is true if paxlsit ia available.
                         * */
                        _showProgramNameDropdown: {
                            type: Boolean,
                            value: true
                        },
                        _remove: {
                            type: String,
                            value: "Remove"
                        },
                        _addNewGuest: {
                            type: String,
                            value: "Add program for other guest"
                        },
                        _guestNameError: {
                            type: String,
                            value: "Please enter guest details first"
                        },
                        _guestName: {
                            type: String,
                            value: "Guest name"
                        },
                        _programName: {
                            type: String,
                            value: "Program name"
                        },
                        _programNumber: {
                            typr: String,
                            value: "Program number"
                        }
                    };
                }
                /**
                 * To set hidden property of remove button.
                 * */
            _lte(loyaltyProgramAdultLength, hiddenButtonAdultNumber) {
                    return loyaltyProgramAdultLength <= hiddenButtonAdultNumber;
                }
                /**
                 * To add loyalty program on click of button 'Add Program For Other Button'.
                 * */
            _addProgramForOtherGuest(e) {
                var loyaltyProgram = {};
                loyaltyProgram.guestName = "";
                loyaltyProgram.programName = "";
                loyaltyProgram.programNumber = "";
                this.push('_loyaltyPrograms', {
                    loyaltyProgram
                });
                this._loyaltyProgramsCount = +this._loyaltyProgramsCount + +1;
                // this.shadowRoot.querySelector("#div" + index).hidden = false;
            }

            /**
             * To delet loyalty profram on click of button 'Remove'.
             **/
            _deleteLoyaltyProgram(e) {
                    var index = parseInt(e.currentTarget.className.replace("c", ""));
                    // var array = this._loyaltyPrograms;
                    if (index > -1) {
                        this.splice('_loyaltyPrograms', index, 0);
                    }
                    this._loyaltyProgramsCount = this._loyaltyProgramsCount - 1;
                    var ele = this.shadowRoot.querySelector("#div" + index);
                    var parent = ele.parentElement;
                    parent.removeChild(ele);

                    for (var i = index; i < this._loyaltyProgramsCount; i++) {
                        this.shadowRoot.querySelector("#div" + (+i + +1)).id = "div" + i;
                        this.shadowRoot.querySelector("#guestName" + (+i + +1)).id = "guestName" + i;
                        this.shadowRoot.querySelector("#programName" + (+i + +1)).id = "programName" + i;
                        this.shadowRoot.querySelector("#programNameInput" + (+i + +1)).id = "programNameInput" + i;
                        this.shadowRoot.querySelector("#programNumber" + (+i + +1)).id = "programNumber" + i;
                        this.shadowRoot.querySelector(".c" + (+i + +1)).className = "c" + i;
                    }
                    // this.shadowRoot.querySelector("#div" + index).hidden = true;
                }
                /**
                 * Using this function on-tap of guest name.
                 * Set the program name and program number if paxlist is available.
                 * */
            _showGuestProgramDetails(e) {
                if (this.paxListAvailable != false) {
                    var paxIndex = e.model.index;
                    var paxListArray = this.paxList;
                    var guestName = this.shadowRoot.querySelector("#guestName" + e.currentTarget.id);
                    var programName = this.shadowRoot.querySelector("#programName" + e.currentTarget.id);
                    var programNameIndex = this.paxList.findIndex(x => x.membership == paxListArray[paxIndex].membership);
                    programName.contentElement.selected = programNameIndex;
                    var programNumber = this.shadowRoot.querySelector("#programNumber" + e.currentTarget.id);
                    programNumber.value = paxListArray[paxIndex].membership.number;
                    guestName.invalid = false;
                    programName.invalid = false;

                    var ind = e.currentTarget.parentElement.parentElement.id.replace("guestName", "");
                    this._loyaltyPrograms[ind].loyaltyProgram.guestName = this.paxList[e.model.index].firstName + ' ' + this.paxList[e.model.index].lastName;
                } else {
                    var list = this._updatePaxList();
                    var ind = e.currentTarget.parentElement.parentElement.id.replace("guestName", "");
                    this._loyaltyPrograms[ind].loyaltyProgram.guestName = list[e.model.index].firstName + ' ' + list[e.model.index].lastName;
                }
            }

            /**
             * To show validation on click of program number.
             * */
            _showValidation(e) {
                    var id = e.currentTarget.id;
                    id = id.replace("programNumber", "");
                    var guestName = this.shadowRoot.querySelector("#guestName" + id);
                    var programName = this.shadowRoot.querySelector("#programName" + id);
                    var programName = this.shadowRoot.querySelector("#programNameInput" + id);
                    if (guestName.value === undefined || guestName.value === "") {
                        guestName.invalid = true;
                    } else {
                        guestName.invalid = false;
                    }
                    if (programName.value === undefined || programName.value === "") {
                        programName.invalid = true;
                    } else {
                        programName.invalid = false;
                    }
                }
                /**
                 * To update the paxlist according to rooms.
                 * If paxList is not given.
                 * */
            _updatePaxList() {
                    if (this.paxListAvailable === false) {
                        var paxInfo = this.guestInfo.isData();
                        var paxTempArray = [];
                        var prodLen = paxInfo.length;
                        for (var i = 0; i < prodLen; i++) {
                            var roomLen = paxInfo[i].length;
                            for (var j = 0; j < roomLen; j++) {
                                var paxLen = paxInfo[i][j].length;
                                for (var k = 0; k < paxLen; k++) {
                                    if (paxInfo[i][j][k].firstName != null) {
                                        paxTempArray.push(paxInfo[i][j][k]);
                                    }
                                }
                            }
                        }
                        var paxList = paxTempArray;
                        for (var i = 0; i < paxList.length; i++) {
                            for (var j = i + 1; j < paxList.length; j++) {
                                if (paxList[i].firstName === paxList[j].firstName &&
                                    paxList[i].lastName === paxList[j].lastName) {
                                    paxList.splice(j, 1);
                                }
                            }
                        }
                        this._tempPaxArray = paxList;
                    } else {
                        this._tempPaxArray = this.paxList;
                    }
                    if (this._tempPaxArray.length === 0) {
                        this._showGuestNameError = false;
                        var len = this._loyaltyPrograms.length;
                        for (var i = 0; i < len; i++) {
                            if (this.smallMobileView === true || this.mobileView === true) {
                                this.shadowRoot.querySelector("#programNumber" + i).style.clear = "both";
                            }
                        }
                        if (this.largeDesktopView === true || this.desktopView === true || this.tabletView === true) {
                            this.shadowRoot.querySelector("#addProgramForOtherGuestButton").style.clear = "both";
                        }
                    } else {
                        this._showGuestNameError = true;
                    }
                    return this._tempPaxArray;
                }
                /**
                 * Program name field if paxlist not given then paper-input.
                 * Program name field if paxlist is given then paper-dropdown-menu.
                 * */
            _showProgramName() {
                if (this.paxListAvailable === false) {
                    this._showProgramNameInput = false;
                } else {
                    this._showProgramNameDropdown = false;
                }
            }
            _showReadMoreDots() {
                var len = this.shadowRoot.querySelector("#guestNameDiv").offsetWidth;
                var l = len / 6.2;
                var gName = this.shadowRoot.querySelector("#guestNameError");
                if (gName.innerText.length > l) {
                    gName.innerText = gName.innerText.substring(0, l) + "..."
                }
            }
            _defaultRsourcesValue() {
                if (this.resources.loyaltyProgram.remove) {
                    this._remove = this.resources.loyaltyProgram.remove;
                }
                if (this.resources.loyaltyProgram.addNewGuest) {
                    this._addNewGuest = this.resources.loyaltyProgram.addNewGuest;
                }
                if (this.resources.loyaltyProgram.guestNameError) {
                    this._guestNameError = this.resources.loyaltyProgram.guestNameError;
                }
                if (this.resources.loyaltyProgram.label.guestName) {
                    this._guestName = this.resources.loyaltyProgram.label.guestName;
                }
                if (this.resources.loyaltyProgram.label.programName) {
                    this._programName = this.resources.loyaltyProgram.label.programName;
                }
                if (this.resources.loyaltyProgram.label.programNumber) {
                    this._programNumber = this.resources.loyaltyProgram.label.programNumber;
                }
            }
            ready() {
                super.ready();
                this._defaultRsourcesValue();
                this._showProgramName();
                this._loyaltyPrograms = [];
                this._addProgramForOtherGuest();

            }
        }
        window.customElements.define(TLoyaltyProgram.is, TLoyaltyProgram);
    </script>
</dom-module>