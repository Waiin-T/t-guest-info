<dom-module id="t-loyalty-program">
  <template>
    <style>
       :host {
        display: block;
      }

      paper-dropdown-menu {
        --paper-input-container-underline-focus: #4CB050;
        --paper-input-container-focus-color: #4CB050;
        --paper-input-container-label-focus: lightgray;
      }

      paper-input {
        --paper-input-container-underline-focus: #4CB050;
        --paper-input-container-focus-color: #4CB050;
        --paper-input-container-label-focus: lightgray;
      }

      .item[smallMobileView] .guestName {
        width: 45%;
        margin-left: -5px;
      }

      .item[smallMobileView] .programName {
        width: 45%;
      }

      .item[smallMobileView] .programNumber {
        width: 45%;
        margin-left: -5px;
      }

      .item[mobileView] .guestName {
        width: 45%;
        margin-left: -5px;
      }

      .item[mobileView] .programName {
        width: 45%;
      }

      .item[mobileView] .programNumber {
        width: 45%;
        margin-left: -5px;
      }



      .item[tabletView] .guestName {
        width: 22%;
      }

      .item[tabletView] .programName {
        width: 22%;
      }

      .item[tabletView] .programNumber {
        width: 22%;
        margin-left: 10px;
      }



      .guestName {
        width: 23%;
        margin-left: 10px;
      }

      .programName {
        width: 23%;
        margin-left: 25px;
      }

      .programNumber {
        width: 23%;
        margin-left: 25px;
      }



      .guestName,
      .programName,
      .programNumber,
      #buttonRemove {
        float: left;
      }



      .item[smallMobileView] #buttonRemove {
        margin-left: 10px;
        margin-top: 20px;
      }

      .item[mobileView] #buttonRemove {
        margin-left: 15px;
        margin-top: 6%;
      }

      .item[tabletView] #buttonRemove {
        margin-top: 5%;
        margin-left: 20px;
      }

      #buttonRemove {
        margin-top: 4%;
        margin-left: 65px;
        width: 60px;
        color: var(--color-for-button-labels);
        font-weight: 450;
      }

      .item[smallMobileView] #addProgramForOtherGuestButton {
        color: var(--color-for-button-labels);
        margin-left: -13px;
        float: left;
        margin-top: 3%;
        padding-bottom: 30px;
      }

      .item[mobileView] #addProgramForOtherGuestButton {
        color: var(--color-for-button-labels);
        margin-left: -13px;
        float: left;
        margin-top: 3%;
        padding-bottom: 30px;
      }

      .item[tabletView] #addProgramForOtherGuestButton {
        color: var(--color-for-button-labels);
        margin-left: 50px;
        float: left;
        margin-top: 3%;
        padding-bottom: 30px;
      }

      #addProgramForOtherGuestButton {
        color: var(--color-for-button-labels);
        margin-left: 6px;
        float: left;
        margin-top: 3%;
        padding-bottom: 30px;
      }

      .item {
        clear: both;
      }
    </style>
    <iron-media-query query="(max-width: 380px)" query-matches="{{smallMobileView}}"></iron-media-query>
    <iron-media-query query="(min-width: 380px) and (max-width:767px)" query-matches="{{mobileView}}"></iron-media-query>
    <iron-media-query query="(min-width: 768px) and (max-width:1023px)" query-matches="{{tabletView}}"></iron-media-query>
    <iron-media-query query="(min-width: 1024px) and (max-width: 1200px)" query-matches="{{desktopView}}"></iron-media-query>
    <iron-media-query query="(min-width: 1200px)" query-matches="{{largeDesktopView}}"></iron-media-query>

    <div class="item" smallMobileView$="{{smallMobileView}}" desktopView$="{{desktopView}}" tabletView$="{{tabletView}}" mobileView$="{{mobileView}}">

      <template is="dom-repeat" items="{{loyaltyPrograms}}" index-as="loyaltyProgramNumber">
        <div style="clear:both">
          <div>
            <paper-dropdown-menu label="Guest name" id="guestName{{loyaltyProgramNumber}}" class="guestName" on-tap="_updatePaxList"
              required auto-validate>
              <paper-listbox slot="dropdown-content" selected="[[guestNameValue]]">
                <template is="dom-repeat" items={{tempPaxArray}}>
                  <paper-item id="{{loyaltyProgramNumber}}" on-tap="_showGuestProgramDetails">{{item.firstName}}&nbsp{{item.lastName}}</paper-item>
                </template>
              </paper-listbox>
            </paper-dropdown-menu>
            <input is="iron-input" type="hidden" bind-value="[[guestNameValue]]">
          </div>
          <div>
            <paper-dropdown-menu label="Program name" id="programName{{loyaltyProgramNumber}}" class="programName" required auto-validate>
              <paper-listbox slot="dropdown-content" selected="[[programNameValue]]">
                <template is="dom-repeat" items={{paxList}}>
                  <paper-item>{{item.membership.programName}}</paper-item>
                </template>
              </paper-listbox>
            </paper-dropdown-menu>
            <input is="iron-input" type="hidden" bind-value="[[programNameValue]]">
          </div>
          <div>
            <paper-input label="Program number" id="programNumber{{loyaltyProgramNumber}}" class="programNumber" on-tap="_showValidation"
              required auto-validate></paper-input>
          </div>
          <div id="buttonRemoveDiv" hidden$=[[_isRemoveButtonHidden]]>
            <paper-button id="buttonRemove" on-tap="_deleteLoyaltyProgram">Remove</paper-button>
          </div>
        </div>
      </template>


      <div>
        <br/>
        <paper-button id="addProgramForOtherGuestButton" on-tap="_addProgramForOtherGuest">Add program for other guest</paper-button>
        <br />
      </div>
    </div>
  </template>


  <script>
    /**
     * `t-loyalty-program`
     * 
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class TLoyaltyProgram extends Polymer.Element {
      static get is() {
        return 't-loyalty-program';
      }
      static get properties() {
        return {
          loyaltyPrograms: {
            type: Array,
            notify: true,
            value: []
          },
          _isRemoveButtonHidden: {
            type: Boolean,
            computed: '_lte(loyaltyPrograms.length , 1)'
          },
          guestNameValue: {
            type: String
          },
          programNameValue: {
            type: String
          },
          smallMobileView: {
            type: Boolean,
            value: false
          },
          mobileView: {
            type: Boolean,
            value: false
          },
          tabletView: {
            type: Boolean,
            value: false
          },
          desktopView: {
            type: Boolean,
            value: false
          },
          largeDesktopView: {
            type: Boolean,
            value: false
          },
          paxList: {
            type: Object,
          },
          loyaltyProgramIds: {
            type: Array,
            value: []
          },
          loyaltyProgramsCount: {
            type: Number,
            value: ''
          },
          paxListAvailable: {
            type: Boolean
          },
          tempPaxArray: {
            type: Array,
            value: []
          },
        };
      }
      _lte(loyaltyProgramAdultLength, hiddenButtonAdultNumber) {
        return loyaltyProgramAdultLength <= hiddenButtonAdultNumber;
      }
      _addProgramForOtherGuest(e) {
        this.push('loyaltyPrograms', {
          loyaltyProgram: ""
        });
      }
      _deleteLoyaltyProgram(e) {
        var index = e.model.index;
        // this.splice('loyaltyProgramIds', index, 1);       
        this.splice('loyaltyPrograms', index, 1, );
        this.loyaltyProgramsCount = this.loyaltyProgramsCount - 1;
      }
      _showGuestProgramDetails(e) {
        if (this.paxListAvailable != false) {
          var paxIndex = e.model.index;
          var paxListArray = this.paxList;
          var guestName = this.shadowRoot.querySelector("#guestName" + e.currentTarget.id);
          var programName = this.shadowRoot.querySelector("#programName" + e.currentTarget.id);
          var programNameIndex = this.paxList.findIndex(x => x.membership == paxListArray[paxIndex].membership);
          programName.contentElement.selected = programNameIndex;
          var programNumber = this.shadowRoot.querySelector("#programNumber" + e.currentTarget.id);
          programNumber.value = paxListArray[paxIndex].membership.number;
          guestName.invalid = false;
          programName.invalid = false;
        }
      }

      _showValidation(e) {
        var id = e.currentTarget.id;
        id = id.replace("programNumber", "")
        var guestName = this.shadowRoot.querySelector("#guestName" + id);
        var programName = this.shadowRoot.querySelector("#programName" + id);
        if (guestName.value === undefined || guestName.value === "") {
          guestName.invalid = true;
        } else {
          guestName.invalid = false;
        }
        if (programName.value === undefined || programName.value === "") {
          programName.invalid = true;
        } else {
          programName.invalid = false;
        }
      }
      _updatePaxList() {
        if (this.paxListAvailable === false) {
          var paxInfo = this.guestInfo.isData();
          var paxTempArray = [];
          var prodLen = paxInfo.length;
          for (var i = 0; i < prodLen; i++) {
            var roomLen = paxInfo[i].length;
            for (var j = 0; j < roomLen; j++) {
              var paxLen = paxInfo[i][j].length;
              for (var k = 0; k < paxLen; k++) {
                if (paxInfo[i][j][k].firstName != null) {
                  paxTempArray.push(paxInfo[i][j][k]);
                }
              }
            }
          }
          var paxList = paxTempArray;
          for (var i = 0; i < paxList.length; i++) {
            for (var j = i + 1; j < paxList.length; j++) {
              if (paxList[i].firstName === paxList[j].firstName &&
                paxList[i].lastName === paxList[j].lastName) {
                paxList.splice(j, 1);
              }
            }
          }
          this.tempPaxArray = paxList;
        } else {
          this.tempPaxArray = this.paxList;
        }
      }

    }
    window.customElements.define(TLoyaltyProgram.is, TLoyaltyProgram);
  </script>
</dom-module>