<link rel="import" href="pax-info.html">

<dom-module id="t-traveler-info">
    <template>
     <style>
         @media only screen 
            and (min-device-width: 320px) 
            and (max-device-width: 568px)
            and (-webkit-min-device-pixel-ratio: 2) {
            #title {
                        font-size: 14px;
                        width: 100%;
                        margin-top: -7px;
                        position: absolute;
                        margin-left: -5px;
                    }
            }
    @media (min-width: 320px) and (max-width: 380px) {
         :host {
            display: block;
            background-color: white;
            margin-left: 10px;
            margin-right: 10px;
        }
        #toolbarRoom {
            background-color: var(--toolbar-background-color);
            width: 100%;
            height: 50px;
            margin-left: -14px;
            padding-right: 5px;
        }
        #productPassengers {
            width: 100%;
            margin-left: 3px;
        }
        #title {
            font-size: 14px;
            width: 100%;
            margin-top: -11px;
            position: absolute;
            margin-left: -5px;
        }
        #subTitle {
            font-size: 13px;
            color: var(--color-for-subTitle);
            width: 100%;
            margin-top: 15px;
            margin-left: -6px;
        }
        #policyList {
            font-size: 13px;
            margin-left: -18px;
             color: var(--color-for-policies);
            margin-top: 10px;
            font-family: roboto;
        }
        .closeIconAdult {
            margin-top: 13%;
            margin-left: -25px;
            color: #A8A8A8;
        }
        .closeIconChild {
            margin-top: 4%;
            margin-left: -22px;
            color: #A8A8A8;
        }
        .closeIconChooseGuest {
            float: left;
            position: absolute;
            margin-top: -39px;
            margin-left: 205px;
            color: #A8A8A8;
            visibility: hidden;
        }
    }
    
    @media (min-width: 380px) and (max-width:767px) {
        #toolbarRoom {
            background-color: var(--toolbar-background-color);
            width: 95%;
            height: 50px;
            margin-left: -14px;
            padding-right: 5px;
        }
        #productPassengers {
            width: 100%;
            margin-left: 10px;
        }
        #title {
            font-size: 14px;
            width: 100%;
            margin-top: -12px;
            position: absolute;
            margin-left: -5px;
        }
        #subTitle {
            font-size: 13px;
            color: var(--color-for-subTitle);
            width: 100%;
            margin-top: 15px;
            margin-left: -6px;
        }
        #policyList {
            font-size: 13px;
            margin-left: -18px;
             color: var(--color-for-policies);
            margin-top: 10px;
            font-family: roboto;
        }
        .closeIconAdult {
            margin-top: 3%;
            margin-left: -26px;
            color: #A8A8A8;
        }
        .closeIconChild {
            margin-top: 4%;
            margin-left: -14px;
            color: #A8A8A8;
        }
        .closeIconChooseGuest {
            float: left;
            position: absolute;
            margin-top: -39px;
            margin-left: 205px;
            color: #A8A8A8;
            visibility: hidden;
        }
    }
    
    @media (min-width: 768px) and (max-width:1023px) {
        #toolbarRoom {
            background-color: var(--toolbar-background-color);
            width: 100%;
            height: 50px;
            margin-left: -6px;
        }
        #productPassengers {
            width: 100%;
        }
        #title {
            font-size: 14px;
            padding: 5px;
        }
        #subTitle {
            font-size: 13px;
            color: var(--color-for-subTitle);
        }
        #policyList {
            font-size: 14px;
            margin-left: -13px;
            width: 100%;
             color: var(--color-for-policies);
            margin-top: 10px;
            font-family: roboto;
        }
        .closeIconAdult {
            margin-top: 4%;
            margin-left: -15px;
            color: #A8A8A8;
        }
        .closeIconChild {
            margin-top: 4%;
            margin-left: -15px;
            color: #A8A8A8;
        }
        .closeIconChooseGuest {
            float: left;
            position: absolute;
            margin-top: -39px;
            margin-left: 205px;
            color: #A8A8A8;
            visibility: hidden;
        }
    }
    
    @media (min-width: 1024px) {
        #toolbarRoom {
            background-color: var(--toolbar-background-color);
            width: 100%;
            margin-left: 10px;
            margin-top: 20px;
            height: 50px;
            clear: both;
        }
        #productPassengers {
            width: 100%;
        }
        #subTitle {
            color: var(--color-for-subTitle);
            font-size: 14px;
            padding: 5px;
        }
        #title {
            font-size: 16px;
            padding: 5px;
        }
        #policyList {
            color: var(--color-for-policies);
            margin-top: 10px;
            font-family: roboto;
        }
        /*#paxInfo, #closeIcon{
                float: left;
            }*/
        .closeIconAdult,
        .closeIconChild {
            margin-top: 3%;
            margin-left: 6px;
            color: #A8A8A8;
        }
        .closeIconChooseGuest {
            float: left;
            position: absolute;
            margin-top: -39px;
            margin-left: 420px;
            color: #A8A8A8;
            visibility: hidden;
        }
    }
    
    #paxInfoTemp {
        padding-bottom: 15px;
        float: left;
        width: 108%;
    }
    
    #checkIcon {
        margin-left: 10px;
    }
</style>
         <iron-media-query query="(max-width: 380px)" query-matches="{{smallMobileView}}"></iron-media-query>
        <iron-media-query query="(min-width: 380px) and (max-width:767px)" query-matches="{{mobileView}}"></iron-media-query>
        <iron-media-query query="(min-width: 768px) and (max-width:1023px)" query-matches="{{tabletView}}"></iron-media-query>
        <iron-media-query query="(min-width: 1024px) and (max-width: 1200px)" query-matches="{{desktopView}}"></iron-media-query>
        <iron-media-query query="(min-width: 1200px)" query-matches="{{largeDesktopView}}"></iron-media-query> 

        <!-- <div class="item" smallMobileView$="{{smallMobileView}}" desktopView$="{{desktopView}}" tabletView$="{{tabletView}}" mobileView$="{{mobileView}}"
            largeDesktopView$="{{_largeDesktopViewOther(largeDesktopView)}}" largeDesktopViewIE$="{{_largeDesktopViewIE(largeDesktopView)}}"> -->

            <div id="productPassengers">
                <app-toolbar id="toolbarRoom">
                    <div id="title">{{productTitle}}</div>
                    <div id="titleDash" hidden$={{_hideDashForMobileView}}> - </div>
                    <div id="subTitle">{{subTitle}}</div>
                </app-toolbar>

                <div id="policyList">
                    <template is="dom-repeat" items={{policyList}}>
                        <br>
                        <div>
                            <div style="float:left">
                                <img id="checkIcon" src="checkImage.svg" height="10" width="10">
                            </div>
                            <div style="margin-left:20px; margin-top:-11px">&nbsp {{item}}</div>
                        </div>
                    </template>
    </div>
    <template is="dom-repeat" items="{{_adultPaxCountArray}}" id="adultPaxTemplate">
                    <div id="paxInfoTemp">
                        <pax-info id="adultPaxInfo{{roomNumber}}{{_increaseIndex(index)}}" pax-list="{{_paxListAdult}}" option="[[option]]" resources="{{resources}}"
                            index-array="{{_indexArray}}" index="{{_increaseIndex(index)}}" traveler-info="{{travelerInfo}}" adult-pax-count="{{adultPaxCount}}"
                            pax-list-available="{{paxListAvailable}}" type="{{adultPax}}"room-number="{{roomNumber}}"></pax-info>
                        <div hidden$=[[_isCloseButtonHidden]]>
                            <paper-icon-button icon="close" id="closeIconAdult{{_increaseIndex(index)}}" class="closeIconAdult" on-tap="_closePaxAdultInfo"></paper-icon-button>
                        </div>
                    </div>
                </template>

    <template is="dom-repeat" items="{{_childPaxCountArray}}" id="childPaxTemplate">
                    <div id="paxInfoTemp">
                        <pax-info id="childPaxInfo{{roomNumber}}{{_increaseIndex(index)}}" pax-list="{{_paxListChild}}" adult-pax-list="" option="[[option]]" resources="{{resources}}"
                            index-array="{{_indexArrayChild}}" type="{{childPax}}" traveler-info="{{travelerInfo}}" child-pax-count="{{childPaxCount}}"
                            index="{{_increaseIndex(index)}}" room-number="{{roomNumber}}" pax-list-available="{{paxListAvailable}}"></pax-info>
                        <div hidden$=[[_isCloseButtonChildHidden]]>
                            <paper-icon-button icon="close" id="closeIconChild{{_increaseIndex(index)}}" class="closeIconChild" on-tap="_closePaxChildInfo"></paper-icon-button>
                        </div>
                    </div>
                </template>
    </div>
    <!-- </div> -->
    </template>

    <script>
        /**
         * `t-traveler-info`
         * 
         *
         * @customElement
         * @polymer
         * @demo demo/index.html
         */
        class TTravelerInfo extends Polymer.GestureEventListeners(Polymer.Element) {
            static get is() {
                return 't-traveler-info';
            }
            static get properties() {
                    return {
                        /**
                         *To set the type adult for pax-info.
                         **/
                        adultPax: {
                            type: String,
                            value: 'Adult'
                        },
                        /**
                         *To set the type child for pax-info.
                         **/
                        childPax: {
                            type: String,
                            value: 'Child'
                        },
                        /**
                         *Object to get t-traveler-info component.
                         **/
                        travelerInfo: {
                            type: Object,
                        },
                        /**
                         *Object to get t-guest-info component.
                         **/
                        guestInfo: {
                            type: Object,
                        },
                        /**
                         *@private
                         *Array to get indexes of selected adult paxList.
                         *used for duplicate pax selected error message purpose.
                         **/
                        _indexArray: {
                            type: Array,
                            value: []
                        },
                        /**
                         *@private
                         *Array to get indexes of selected child paxlist.
                         *used for duplicate pax selected error message purpose.
                         **/
                        _indexArrayChild: {
                            type: Array,
                            value: []
                        },
                        /**
                         *Pass the current roomNumber to pax-info.
                         **/
                        roomNumber: {
                            type: Number
                        },
                        /**
                         *To set title property for room.
                         **/
                        productTitle: {
                            type: String,
                            value: 'Room'
                        },
                        /**
                         *To set subtitle property for room.
                         **/
                        subTitle: {
                            type: String,
                        },
                        /**
                         *@private
                         *To set the iron media queries.
                         **/
                        smallMobileView: {
                            type: Boolean,
                            value: false
                        },
                        /**
                         *@private
                         *iron media query properties.
                         **/
                        mobileView: {
                            type: Boolean,
                            value: false
                        },
                        /**
                         *@private
                         *iron media query properties.
                         **/
                        tabletView: {
                            type: Boolean,
                            value: false
                        },
                        /**
                         *@private
                         *iron media query properties.
                         **/
                        desktopView: {
                            type: Boolean,
                            value: false
                        },
                        /**
                         *@private
                         *iron media query properties.
                         **/
                        largeDesktopView: {
                            type: Boolean,
                            value: false
                        },
                        /**
                         *@private
                         *Boolean property to hide dash for mobile view.
                         * which is present in between title and subtitle.
                         **/
                        _hideDashForMobileView: {
                            type: Boolean,
                            value: false
                        },
                        /**
                         *To set the option property.
                         **/
                        option: {
                            type: Object,
                            value: {
                                "requiredField": [],
                                "requiredFieldForLeadPax": []
                            }
                        },
                        /**
                         *Adult pax count set for room.
                         **/
                        adultPaxCount: {
                            type: Number,
                            value: ''
                        },
                        /**
                         *@private
                         *Array used for adult pax info.
                         **/
                        _adultPaxCountArray: {
                            type: Array,
                            value: ''
                        },
                        /**
                         *Child pax count set for room.
                         **/
                        childPaxCount: {
                            type: Number,
                            value: ''
                        },
                        /**
                         *@private
                         *Array used for child pax info.
                         **/
                        _childPaxCountArray: {
                            type: Array,
                            value: ''
                        },
                        /**
                         *To set the paxlist.
                         **/
                        paxlist: {
                            type: Array,
                        },
                        /**
                         *@private
                         *To set the sorted paxlist for adult.
                         **/
                        _paxListAdult: {
                            type: Array,
                        },
                        /**
                         *@private
                         *To set the sorted pax list for child.
                         **/
                        _paxListChild: {
                            type: Array,
                        },
                        /**
                         *Set the flag where paxlist is available or not.
                         **/
                        paxListAvailable: {
                            type: Boolean,
                        },
                        /**
                         *To set policy list for a room.
                         **/
                        policyList: {
                            type: Array,
                        },
                        /**
                         *To set the resources.
                         **/
                        resources: {
                            type: Object
                        },
                        /**
                         *@private
                         *Computed property to hide and show close button for adult.
                         **/
                        _isCloseButtonHidden: {
                            type: Boolean,
                            computed: '_lte(_adultPaxCountArray.length , 1)'
                        },
                        /**
                         *@private
                         *Computed property to hide and show close button for child.
                         **/
                        _isCloseButtonChildHidden: {
                            type: Boolean,
                            computed: '_lteChild()'
                        }
                    };
                }
                /**
                 *To fire valiadtion for a room.
                 **/
            isValid() {
                    var adultValidation = this.isValidAdult();
                    var childValidation = this.isValidChild();
                    if (!(adultValidation && childValidation)) {
                        return false;
                    } else {
                        return true;
                    }
                }
                /**
                 *To fire validation for adult in a room.
                 **/
            isValidAdult() {
                    var adultPaxInfoArray = [];
                    var validData = true;
                    for (var i = 1; i <= this.adultPaxCount; i++) {
                        adultPaxInfoArray[i] = this.shadowRoot.querySelector("#adultPaxInfo" + this.roomNumber + (i))
                            .isValidPaxInfo();
                    }
                    for (var i = 1; i <= this.adultPaxCount; i++) {
                        if (adultPaxInfoArray[i] === true) {
                            validData = false;
                        }
                    }
                    if (validData === true) {
                        return true;
                    } else {
                        return false;
                    }
                }
                /**
                 *To fire validation for child in a room.
                 **/
            isValidChild() {
                    var childPaxInfoArray = [];
                    var validData = true;
                    for (var i = 1; i <= this.childPaxCount; i++) {
                        childPaxInfoArray[i] = this.shadowRoot.querySelector("#childPaxInfo" + this.roomNumber + (i))
                            .isValidPaxInfo();
                    }
                    for (var i = 1; i <= this.childPaxCount; i++) {
                        if (childPaxInfoArray[i] === true) {
                            validData = false;
                        }
                    }
                    if (validData === true) {
                        return true;
                    } else {
                        return false;
                    }
                }
                /**
                 *TO collect data from a room.
                 **/
            getState(event) {
                var adultPaxDataArray = [];
                for (var i = 0; i < this.adultPaxCount; i++) {
                    var adultPax = this.shadowRoot.querySelector("#adultPaxInfo" + this.roomNumber + (i + 1));
                    adultPaxDataArray[i] = this.shadowRoot.querySelector("#adultPaxInfo" + this.roomNumber + (i +
                        1)).collectData();
                }
                for (var i = 0; i < adultPaxDataArray.length; i++) {
                    var adult = this.shadowRoot.querySelector("#adultPaxInfo" + this.roomNumber + (i +
                        1));
                    if (adult.shadowRoot.querySelector("#adultFirstName") === undefined) {
                        adult.shadowRoot.querySelector("#adultFirstName").invalid = false;
                    }
                }
                for (var i = 0; i < adultPaxDataArray.length; i++) {
                    for (var j = i + 1; j < adultPaxDataArray.length; j++) {
                        var adult = this.shadowRoot.querySelector("#adultPaxInfo" + this.roomNumber + (j +
                            1));
                        if (adultPaxDataArray[i].firstName === adultPaxDataArray[j].firstName &&
                            adultPaxDataArray[i].lastName === adultPaxDataArray[j].lastName &&
                            adultPaxDataArray[i].firstName != undefined && adultPaxDataArray[i].firstName != "" &&
                            adultPaxDataArray[i].lastName != undefined && adultPaxDataArray[i].lastName != "") {

                            adult.shadowRoot.querySelector("#adultFirstName").invalid = true;
                            adult.shadowRoot.querySelector("#adultFirstName").errorMessage =
                                "Duplicate guest name";
                        } else if (adult.shadowRoot.querySelector("#adultFirstName").value != undefined &&
                            adult.shadowRoot.querySelector("#adultFirstName").value != "") {
                            adult.shadowRoot.querySelector("#adultFirstName").invalid = false;
                        }
                    }
                }

                var childPaxDataArray = [];
                for (var i = 0; i < this.childPaxCount; i++) {
                    childPaxDataArray[i] = this.shadowRoot.querySelector("#childPaxInfo" + this.roomNumber + (i +
                        1)).collectData();
                }
                for (var i = 0; i < childPaxDataArray.length; i++) {
                    var child = this.shadowRoot.querySelector("#childPaxInfo" + this.roomNumber + (i +
                        1));
                    if (child.shadowRoot.querySelector("#adultFirstName") === undefined) {
                        child.shadowRoot.querySelector("#adultFirstName").invalid = false;
                    }
                }
                for (var i = 0; i < childPaxDataArray.length; i++) {
                    for (var j = i + 1; j < childPaxDataArray.length; j++) {
                        var child = this.shadowRoot.querySelector("#childPaxInfo" + this.roomNumber + (j +
                            1));
                        if (childPaxDataArray[i].firstName === childPaxDataArray[j].firstName &&
                            childPaxDataArray[i].lastName === childPaxDataArray[j].lastName &&
                            childPaxDataArray[i].firstName != undefined && childPaxDataArray[i].firstName != "" &&
                            childPaxDataArray[i].lastName != undefined && childPaxDataArray[i].lastName != "") {
                            child.shadowRoot.querySelector("#adultFirstName").invalid = true;
                            child.shadowRoot.querySelector("#adultFirstName").errorMessage =
                                "Duplicate guest name";
                        } else
                        if (child.shadowRoot.querySelector("#adultFirstName").value != undefined && child.shadowRoot
                            .querySelector("#adultFirstName").value != "") {
                            child.shadowRoot.querySelector("#adultFirstName").invalid = false;
                        }
                    }
                }
                var paxListArray = adultPaxDataArray.concat(childPaxDataArray);
                this.paxList = JSON.parse(JSON.stringify(paxListArray));
                return this.paxList;
            }
            setState(paxList) {
                    var count = this.adultPaxCount + this.childPaxCount;
                    var finalData = [];
                    for (var i = 0; i < count; i++) {
                        finalData[i] = this.paxList[i];
                    }
                    return finalData;
                }
                /**
                 *To hide the close button if adult is only one.
                 **/
            _lte(adultPaxCountArrayLength, hiddenButtonAdultNumber) {
                    if (this.roomNumber === 1 && this.paxList.length === 0) {
                        return true;
                    } else {
                        return adultPaxCountArrayLength <= hiddenButtonAdultNumber;
                    }
                }
                /**
                 *To hide the close button for child pax.
                 **/
            _lteChild() {
                    if (this.roomNumber === 1 && this.paxList.length === 0) {
                        return true;
                    } else {
                        return false;
                    }
                }
                /**
                 *To hide dash in between title and subtitle at mobileview.
                 **/
            _hideDashForMobileViewMethod() {
                    if (this.smallMobileView === true || this.mobileView === true) {
                        this._hideDashForMobileView = true;
                    } else {
                        this._hideDashForMobileView = false;
                    }
                }
                /**
                 *on click of close button for adult pax.
                 **/
            _closePaxAdultInfo(e) {
                    var adultPaxInfoVar = this.shadowRoot.querySelector("#adultPaxInfo" + this.roomNumber + (e.model
                        .index + 1));
                    var firstName = adultPaxInfoVar.shadowRoot.querySelector("#adultFirstName").value;
                    if (this.paxListAvailable === false) {
                        var paxL = adultPaxInfoVar._loadPaxList(e);
                        var paxIndex = paxL.findIndex(x => x.firstName == firstName);
                    } else {
                        var paxIndex = this.paxList.findIndex(x => x.firstName == firstName);
                    }
                    var indexOfPax = this._indexArray.indexOf(paxIndex);
                    if (indexOfPax > -1) {
                        this._indexArray.splice(indexOfPax, 1);
                    }
                    adultPaxInfoVar._showChooseGuest = false;
                    adultPaxInfoVar._showChooseGuestDuplicateError = true;
                    adultPaxInfoVar._showPaxInfoFields = true;
                    adultPaxInfoVar.shadowRoot.querySelector("#chooseGuest").invalid = false;
                    var closeIconAdultVar = this.shadowRoot.querySelector("#closeIconAdult" + (e.model.index + 1))
                    closeIconAdultVar.classList.add("closeIconChooseGuest");
                    closeIconAdultVar.classList.remove("closeIconAdult");
                    var paxInfo = this.shadowRoot.querySelector("#adultPaxInfo" + this.roomNumber + (e.model.index +
                        1));
                    paxInfo.shadowRoot.querySelector("#chooseGuest").contentElement.selected = -1;
                }
                /**
                 *On click of close button of child pax.
                 **/
            _closePaxChildInfo(e) {
                    var childPaxInfoVar = this.shadowRoot.querySelector("#childPaxInfo" + this.roomNumber + (e.model
                        .index + 1));
                    var firstName = childPaxInfoVar.shadowRoot.querySelector("#adultFirstName").value;
                    if (this.paxListAvailable === false) {
                        var paxL = childPaxInfoVar._loadPaxList(e);
                        var paxIndex = paxL.findIndex(x => x.firstName == firstName);
                    } else {
                        var paxIndex = this.paxList.findIndex(x => x.firstName == firstName);
                    }
                    var indexOfPax = this._indexArrayChild.indexOf(paxIndex);
                    if (indexOfPax > -1) {
                        this._indexArrayChild.splice(indexOfPax, 1);
                    }
                    childPaxInfoVar._showChooseGuest = false;
                    childPaxInfoVar._showPaxInfoFields = true;
                    childPaxInfoVar.shadowRoot.querySelector("#chooseGuest").invalid = false;
                    var closeIconchildVar = this.shadowRoot.querySelector("#closeIconChild" + (e.model.index +
                        1))
                    closeIconchildVar.classList.add("closeIconChooseGuest");
                    closeIconchildVar.classList.remove("closeIconChild");
                    var paxInfo = this.shadowRoot.querySelector("#childPaxInfo" + this.roomNumber + (e.model.index +
                        1));
                    paxInfo.shadowRoot.querySelector("#chooseGuest").contentElement.selected = -1;
                }
                /**
                 *To increase the index of template by 1.
                 **/
            _increaseIndex(index) {
                    var calIndex = index + 1;
                    return calIndex;
                }
                /**
                 *To sort provided paxList as type adult.
                 **/
            _getAdultPaxList() {
                    if (this.paxList) {
                        var paxList = this.paxList;
                        var adults = paxList.filter(function(item) {
                            return item.type.toLowerCase() === 'adult';
                        });
                        this._paxListAdult = adults;
                    }
                }
                /**
                 *To sort provided paxList as type child.
                 **/
            _getChildPaxList() {
                    if (this.paxList) {
                        var paxList = this.paxList;
                        var children = paxList.filter(function(item) {
                            return item.type.toLowerCase() === 'child';
                        });
                        this._paxListChild = children;
                    }
                }
                /**
                 * Function to set view of internet explorer.       
                 * */
            _largeDesktopViewIE(largeDesktopView) {
                    // Internet Explorer 6-11
                    var isIE = /*@cc_on!@*/ false || !!document.documentMode;
                    return isIE && largeDesktopView;
                }
                /**
                 * Function for desktop view for browsers other than internet explorer.
                 * */
            _largeDesktopViewOther(largeDesktopView) {
                // Internet Explorer 6-11
                var isIE = /*@cc_on!@*/ false || !!document.documentMode;
                return !isIE && largeDesktopView;
            }
            ready() {
                super.ready();
                var leadPaxInfo = this.onlyLeadPaxInfo;
                if (leadPaxInfo === true) {
                    this.adultPaxCount = 1;
                    this.childPaxCount = 0;
                }
                var adultPax = this.adultPaxCount;
                var childPax = this.childPaxCount;
                var totalPax = +adultPax + +childPax;
                var adultPaxCount1 = [];
                for (var i = 0; i < adultPax; i++) {
                    adultPaxCount1.push(i);
                }
                this._adultPaxCountArray = adultPaxCount1;
                var childPaxCount1 = [];
                for (var i = 0; i < childPax; i++) {
                    childPaxCount1.push(i);
                }
                this._childPaxCountArray = childPaxCount1;
                this._hideDashForMobileViewMethod();
                this._getAdultPaxList();
                this._getChildPaxList();
                this.travelerInfo = this;
                this._indexArray = [];
                this._indexArrayChild = [];
            }
        }

        window.customElements.define(TTravelerInfo.is, TTravelerInfo);
    </script>
</dom-module>