<link rel="import" href="pax-info.html">
<link rel="import" href="pax-info-child.html">

<dom-module id="t-traveler-info">
    <template>
        <style>
            .item[smallMobileView] #toolbarRoom {
                background-color: var(--toolbar-background-color);
                width: 100%;
                height: 50px;
                margin-left: -14px;
            }

            .item[smallMobileView] #productPassengers {
                width: 100%;
                margin-left: 3px;
            }

            .item[smallMobileView] #title {
                font-size: 14px;
                width: 100%;
                margin-top: -12px;
                position: absolute;
                margin-left: -5px;
            }

            .item[smallMobileView] #subTitle {
                /*color: var(--color-for-subTitle);                */
                font-size: 13px;
                color: var(--color-for-subTitle);
                width: 100%;
                margin-top: 15px;
                margin-left: -6px;
            }

            .item[smallMobileView] #policyList {
                font-size: 13px;
                margin-left: -18px;
            }

            .item[smallMobileView] .closeIconAdult {
                margin-top: 4%;
                margin-left: -21px;
                color: #A8A8A8;
            }

            .item[smallMobileView] .closeIconChild {
                margin-top: 4%;
                margin-left: -11px;
                color: #A8A8A8;
            }

            .item[smallMobileView] .closeIconChooseGuest {
                float: left;
                position: absolute;
                margin-top: -39px;
                margin-left: 205px;
                color: #A8A8A8;
                visibility: hidden;
            }

            .item[mobileView] #toolbarRoom {
                background-color: var(--toolbar-background-color);
                width: 100%;
                height: 50px;
                margin-left: -14px;
            }

            .item[mobileView] #productPassengers {
                width: 100%;
            }

            .item[mobileView] #title {
                font-size: 14px;
                width: 100%;
                margin-top: -12px;
                position: absolute;
                margin-left: -5px;
            }

            .item[mobileView] #subTitle {
                /*color: var(--color-for-subTitle);                */
                font-size: 13px;
                color: var(--color-for-subTitle);
                width: 100%;
                margin-top: 15px;
                margin-left: -6px;
            }

            .item[mobileView] #policyList {
                font-size: 13px;
                margin-left: -18px;
            }

            .item[mobileView] .closeIconAdult {
                margin-top: 4%;
                margin-left: -14px;
                color: #A8A8A8;
            }

            .item[mobileView] .closeIconChild {
                margin-top: 4%;
                margin-left: -14px;
                color: #A8A8A8;
            }

            .item[mobileView] .closeIconChooseGuest {
                float: left;
                position: absolute;
                margin-top: -39px;
                margin-left: 205px;
                color: #A8A8A8;
                visibility: hidden;
            }

            .item[tabletView] #toolbarRoom {
                background-color: var(--toolbar-background-color);
                width: 100%;
                height: 50px;
                margin-left: -6px;
            }

            .item[tabletView] #productPassengers {
                width: 64%;
            }

            .item[tabletView] #extraSpace {
                margin-top: 20px;
                margin-left: 50px;
                width: 30%;
                border: 1px solid lightgray;
                border-right: rebeccapurple solid 1px;
            }

            .item[tabletView] #title {
                font-size: 14px;
                padding: 5px;
            }

            .item[tabletView] #subTitle {
                /*color: var(--color-for-subTitle);                */
                font-size: 13px;
                color: var(--color-for-subTitle);
            }

            .item[tabletView] #policyList {
                font-size: 14px;
                margin-left: -13px;
                width: 100%;
            }

            .item[tabletView] .closeIconAdult {
                margin-top: 4%;
                margin-left: -15px;
                color: #A8A8A8;
            }

            .item[tabletView] .closeIconChild {
                margin-top: 4%;
                margin-left: -15px;
                color: #A8A8A8;
            }

            .item[tabletView] .closeIconChooseGuest {
                float: left;
                position: absolute;
                margin-top: -39px;
                margin-left: 205px;
                color: #A8A8A8;
                visibility: hidden;
            }

            #toolbarRoom {
                background-color: var(--toolbar-background-color);
                width: 100%;
                margin-left: 10px;
                margin-top: 20px;
                height: 50px;
                clear: both;
            }

            #productPassengers {
                width: 65%;
            }

            #extraSpace {
                margin-top: 20px;
                margin-left: 50px;
                width: 30%;
                border: 1px solid lightgray;
                border-right: rebeccapurple solid 1px;
            }
            /* #productPassengers, */

            #extraSpace {
                float: left;
            }

            #subTitle {
                color: var(--color-for-subTitle);
                font-size: 14px;
                padding: 5px;
            }

            #title {
                font-size: 16px;
                padding: 5px;
            }

            #policyList {
                color: var(--color-for-policies);
                margin-top: 10px;
                font-family: roboto;
            }

            #checkIcon {
                margin-left: 10px;
            }
            /*#paxInfo, #closeIcon{
                float: left;
            }*/

            .closeIconAdult,
            .closeIconChild {
                margin-top: 3%;
                margin-left: 18px;
                color: #A8A8A8;
            }

            .closeIconChooseGuest {
                float: left;
                position: absolute;
                margin-top: -39px;
                margin-left: 420px;
                color: #A8A8A8;
                visibility: hidden;
            }

            #paxInfoTemp {
                padding-bottom: 15px;
                float: left;
                width: 108%;
            }
        </style>
        <iron-media-query query="(max-width: 380px)" query-matches="{{smallMobileView}}"></iron-media-query>
        <iron-media-query query="(min-width: 380px) and (max-width:767px)" query-matches="{{mobileView}}"></iron-media-query>
        <iron-media-query query="(min-width: 768px) and (max-width:1023px)" query-matches="{{tabletView}}"></iron-media-query>
        <iron-media-query query="(min-width: 1024px) and (max-width: 1200px)" query-matches="{{desktopView}}"></iron-media-query>
        <iron-media-query query="(min-width: 1200px)" query-matches="{{largeDesktopView}}"></iron-media-query>

        <div class="item" smallMobileView$="{{smallMobileView}}" desktopView$="{{desktopView}}" tabletView$="{{tabletView}}" mobileView$="{{mobileView}}"
            largeDesktopView$="{{_largeDesktopViewOther(largeDesktopView)}}" largeDesktopViewIE$="{{_largeDesktopViewIE(largeDesktopView)}}">

            <div id="productPassengers">
                <app-toolbar id="toolbarRoom">
                    <div id="title">{{title}}</div>
                    <div id="titleDash" hidden$={{hideDashForMobileView}}> - </div>
                    <div id="subTitle">{{subTitle}}</div>
                </app-toolbar>

                <div id="policyList">
                    <template is="dom-repeat" items={{policyList}}>
                        <br>
                        <div>
                            <div style="float:left">
                                <img id="checkIcon" src="checkImage.svg" height="10" width="10">
                            </div>
                            <div style="margin-left:20px; margin-top:-11px"> {{item}}</div>
                        </div>
                    </template>
                </div>
                <template is="dom-repeat" items="{{adultPaxCountArray}}">
                    <div id="paxInfoTemp">
                        <pax-info id="adultPaxInfo{{roomNumber}}{{_increaseIndex(index)}}" pax-list="{{paxListAdult}}" option="[[option]]" resources="{{resources}}"
                            index-array="{{indexArray}}" index="{{_increaseIndex(index)}}" traveler-info="{{travelerInfo}}" adult-pax-count="{{adultPaxCount}}"
                            pax-list-available="{{paxListAvailable}}" room-number="{{roomNumber}}">{{item}}</pax-info>
                        <div hidden$=[[_isCloseButtonHidden]]>
                            <paper-icon-button icon="close" id="closeIconAdult{{_increaseIndex(index)}}" class="closeIconAdult" on-tap="_closePaxAdultInfo"></paper-icon-button>
                        </div>
                    </div>
                </template>

                <template is="dom-repeat" items="{{childPaxCountArray}}">
                    <div id="paxInfoTemp">
                        <pax-info-child id="childPaxInfo{{roomNumber}}{{_increaseIndex(index)}}" pax-list="{{paxListChild}}" option="[[option]]"
                            resources="{{resources}}" index-array-child="{{indexArrayChild}}" traveler-info="{{travelerInfo}}"
                            index="{{_increaseIndex(index)}}" room-number="{{roomNumber}}"></pax-info-child>
                        <div hidden$=[[_isCloseButtonChildHidden]]>
                            <paper-icon-button icon="close" id="closeIconChild{{_increaseIndex(index)}}" class="closeIconChild" on-tap="_closePaxChildInfo"></paper-icon-button>
                        </div>
                    </div>
                </template>
            </div>
            <!--<div id="extraSpace">
            </div>-->
        </div>
    </template>

    <script>
        /**
         * `t-traveler-info`
         * 
         *
         * @customElement
         * @polymer
         * @demo demo/index.html
         */
        class TTravelerInfo extends Polymer.Element {
            static get is() {
                return 't-traveler-info';
            }
            static get properties() {
                return {
                    travelerInfo: {
                        type: Object,
                    },
                    guestInfo: {
                        type: Object,
                    },
                    indexArray: {
                        type: Array,
                        value: []
                    },
                    indexArrayChild: {
                        type: Array,
                        value: []
                    },
                    roomNumber: {
                        type: Number
                    },
                    title: {
                        type: String,
                        value: 'Room'
                    },
                    subTitle: {
                        type: String,
                    },
                    smallMobileView: {
                        type: Boolean,
                        value: false
                    },
                    mobileView: {
                        type: Boolean,
                        value: false
                    },
                    tabletView: {
                        type: Boolean,
                        value: false
                    },
                    desktopView: {
                        type: Boolean,
                        value: false
                    },
                    largeDesktopView: {
                        type: Boolean,
                        value: false
                    },
                    hideDashForMobileView: {
                        type: Boolean,
                        value: false
                        // computed: '_hideDashForMobileView()'
                    },
                    option: {
                        type: Object,
                        value: {
                            "requiredField": [],
                            "requiredFieldForLeadPax": []
                        }
                    },
                    adultPaxCount: {
                        type: Number,
                        value: ''
                    },
                    adultPaxCountArray: {
                        type: Array,
                        value: ''
                    },
                    childPaxCount: {
                        type: Number,
                        value: ''
                    },
                    childPaxCountArray: {
                        type: Array,
                        value: ''
                    },
                    totalPaxCount: {
                        type: Array,
                        value: ''
                    },
                    paxlist: {
                        type: Array,
                    },
                    paxListAdult: {
                        type: Array,
                    },
                    paxListChild: {
                        type: Array,
                    },
                    paxListAvailable: {
                        type: Boolean,
                    },
                    policyList: {
                        type: Array,
                    },
                    resources: {
                        type: Object
                    },
                    showCloseButton: {
                        type: Boolean,
                        value: false
                    },
                    _isCloseButtonHidden: {
                        type: Boolean,
                        computed: '_lte(adultPaxCountArray.length , 1)'
                    },
                    _isCloseButtonChildHidden: {
                        type: Boolean,
                        computed: '_lteChild()'
                    }
                };
            }

            isValid() {
                var adultValidation = this.isValidAdult();
                var childValidation = this.isValidChild();
                if (!(adultValidation && childValidation)) {
                    return false;
                } else {
                    return true;
                }
            }
            isValidAdult() {
                var adultPaxInfoArray = [];
                var validData = true;
                for (var i = 1; i <= this.adultPaxCount; i++) {
                    adultPaxInfoArray[i] = this.shadowRoot.querySelector("#adultPaxInfo" + this.roomNumber + (i))
                        .isValidPaxInfo();
                }
                for (var i = 1; i <= this.adultPaxCount; i++) {
                    if (adultPaxInfoArray[i] === true) {
                        validData = false;
                    }
                }
                if (validData === true) {
                    return true;
                } else {
                    return false;
                }
            }
            isValidChild() {
                var childPaxInfoArray = [];
                var validData = true;
                for (var i = 1; i <= this.childPaxCount; i++) {
                    childPaxInfoArray[i] = this.shadowRoot.querySelector("#childPaxInfo" + this.roomNumber + (i))
                        .isValidPaxInfoChild();
                }
                for (var i = 1; i <= this.childPaxCount; i++) {
                    if (childPaxInfoArray[i] === true) {
                        validData = false;
                    }
                }
                if (validData === true) {
                    return true;
                } else {
                    return false;
                }
            }
            getState(event) {
                // console.log(this.id);
                var adultPaxDataArray = [];
                for (var i = 0; i < this.adultPaxCount; i++) {
                    var adultPax = this.shadowRoot.querySelector("#adultPaxInfo" + this.roomNumber + (i + 1));

                    adultPaxDataArray[i] = this.shadowRoot.querySelector("#adultPaxInfo" + this.roomNumber + (i +
                        1)).adultData();
                }
                for (var i = 0; i < adultPaxDataArray.length; i++) {
                    var adult = this.shadowRoot.querySelector("#adultPaxInfo" + this.roomNumber + (i +
                        1));
                    adult.shadowRoot.querySelector("#adultFirstName").invalid = false;
                }
                for (var i = 0; i < adultPaxDataArray.length; i++) {
                    for (var j = i + 1; j < adultPaxDataArray.length; j++) {
                        var adult = this.shadowRoot.querySelector("#adultPaxInfo" + this.roomNumber + (i +
                            1));
                        if (adultPaxDataArray[i].FirstName === adultPaxDataArray[j].FirstName &&
                            adultPaxDataArray[i].LastName === adultPaxDataArray[j].LastName &&
                            adultPaxDataArray[i].FirstName != undefined &&
                            adultPaxDataArray[i].LastName != undefined) {

                            adult.shadowRoot.querySelector("#adultFirstName").invalid = true;
                            adult.shadowRoot.querySelector("#adultFirstName").errorMessage =
                                "Duplicate guest name";
                        } 
                     } 
                }
                for (var i = 0; i < adultPaxDataArray.length; i++) {
                var adult = this.shadowRoot.querySelector("#adultPaxInfo" + this.roomNumber + (i +
                            1));
                if (adultPaxDataArray[i].FirstName === undefined &&
                            adultPaxDataArray[i].LastName === undefined) {
                            adult.shadowRoot.querySelector("#adultFirstName").invalid = true;
                        } else {
                            adult.shadowRoot.querySelector("#adultFirstName").invalid = false;
                        }
                    
                }

                var childPaxDataArray = [];
                for (var i = 0; i < this.childPaxCount; i++) {
                    childPaxDataArray[i] = this.shadowRoot.querySelector("#childPaxInfo" + this.roomNumber + (i +
                        1)).childData();
                }
                for (var i = 0; i < childPaxDataArray.length; i++) {
                    var child = this.shadowRoot.querySelector("#childPaxInfo" + this.roomNumber + (i +
                        1));
                    child.shadowRoot.querySelector("#firstName").invalid = false;
                }
                for (var i = 0; i < childPaxDataArray.length; i++) {
                    for (var j = i + 1; j < childPaxDataArray.length; j++) {
                        if (childPaxDataArray[i].FirstName === childPaxDataArray[j].FirstName &&
                            childPaxDataArray[i].LastName === childPaxDataArray[j].LastName && childPaxDataArray[i].FirstName != undefined &&
                            childPaxDataArray[i].LastName != undefined) {
                            child.shadowRoot.querySelector("#firstName").invalid = true;
                            child.shadowRoot.querySelector("#firstName").errorMessage = "Duplicate guest name";
                        } 
                    }
                    }
                for (var i = 0; i < childPaxDataArray.length; i++) {
                  var child = this.shadowRoot.querySelector("#childPaxInfo" + this.roomNumber + (i +
                        1));   
                    if (childPaxDataArray[i].FirstName === undefined &&
                            childPaxDataArray[i].LastName === undefined) {
                            child.shadowRoot.querySelector("#firstName").invalid = true;
                        } else {
                            child.shadowRoot.querySelector("#firstName").invalid = false;
                        }
                    
                }
                var paxListArray = adultPaxDataArray.concat(childPaxDataArray);
                this.paxList = JSON.parse(JSON.stringify(paxListArray));
                return this.paxList;
            }
            setState(paxList) {
                var count = this.adultPaxCount + this.childPaxCount;
                var finalData = [];
                for (var i = 0; i < count; i++) {
                    finalData[i] = paxList[i];
                }
                // console.log(finalData);
            }
            _lte(adultPaxCountArrayLength, hiddenButtonAdultNumber) {
                if (this.roomNumber === 1 && this.paxList.length === 0) {
                    return true;
                } else {
                    return adultPaxCountArrayLength <= hiddenButtonAdultNumber;
                }
            }
            _lteChild() {
                if (this.roomNumber === 1 && this.paxList.length === 0) {
                    return true;
                } else {
                    return false;
                }
            }

            _hideDashForMobileView() {
                if (this.smallMobileView === true || this.mobileView === true) {
                    this.hideDashForMobileView = true;
                } else {
                    this.hideDashForMobileView = false;
                }
            }
            _closeIconIfAdultIsOnlyOne() {
                var adultCount = this.adultPaxCount;
                if (adultCount === 1) {
                    this.showCloseButton = true;
                }
            }
            _closePaxAdultInfo(e) {
                var adultPaxInfoVar = this.shadowRoot.querySelector("#adultPaxInfo" + this.roomNumber + (e.model
                    .index + 1));
                var firstName = adultPaxInfoVar.shadowRoot.querySelector("#adultFirstName").value;
                var paxIndex = this.paxList.findIndex(x => x.firstName == firstName);
                var indexOfPax = this.indexArray.indexOf(paxIndex);
                if (indexOfPax > -1) {
                    this.indexArray.splice(indexOfPax, 1);
                }
                adultPaxInfoVar.showChooseGuest = false;
                adultPaxInfoVar.showPaxInfoFields = true;
                adultPaxInfoVar.shadowRoot.querySelector("#chooseGuest").invalid = false;
                var closeIconAdultVar = this.shadowRoot.querySelector("#closeIconAdult" + (e.model.index + 1))
                closeIconAdultVar.classList.add("closeIconChooseGuest");
                closeIconAdultVar.classList.remove("closeIconAdult");
                var paxInfo = this.shadowRoot.querySelector("#adultPaxInfo" + this.roomNumber + (e.model.index +
                    1));
                paxInfo.shadowRoot.querySelector("#chooseGuest").contentElement.selected = -1;
            }
            _closePaxChildInfo(e) {
                var childPaxInfoVar = this.shadowRoot.querySelector("#childPaxInfo" + this.roomNumber + (e.model
                    .index + 1));
                var firstName = childPaxInfoVar.shadowRoot.querySelector("#firstName").value;
                var paxIndex = this.paxList.findIndex(x => x.firstName == firstName);
                var indexOfPax = this.indexArrayChild.indexOf(paxIndex);
                if (indexOfPax > -1) {
                    this.indexArrayChild.splice(indexOfPax, 1);
                }
                childPaxInfoVar.showChooseGuest = false;
                childPaxInfoVar.showPaxInfoFields = true;
                childPaxInfoVar.shadowRoot.querySelector("#chooseGuest").invalid = false;
                var closeIconchildVar = this.shadowRoot.querySelector("#closeIconChild" + (e.model.index +
                    1))
                closeIconchildVar.classList.add("closeIconChooseGuest");
                closeIconchildVar.classList.remove("closeIconChild");
                var paxInfo = this.shadowRoot.querySelector("#childPaxInfo" + this.roomNumber + (e.model.index +
                    1));
                paxInfo.shadowRoot.querySelector("#chooseGuest").contentElement.selected = -1;
            }
            _increaseIndex(index) {
                var calIndex = index + 1;
                return calIndex;
            }
            _getAdultPaxList() {
                if (this.paxList) {
                    var paxList = this.paxList;
                    var adults = paxList.filter(function (item) {
                        return item.type.toLowerCase() === 'adult';
                    });
                    this.paxListAdult = adults;
                }
            }
            _getChildPaxList() {
                if (this.paxList) {
                    var paxList = this.paxList;
                    var children = paxList.filter(function (item) {
                        return item.type.toLowerCase() === 'child';
                    });
                    this.paxListChild = children;
                }
            }
            /**
             * Function to set view of internet explorer.       
             * */
            _largeDesktopViewIE(largeDesktopView) {
                // Internet Explorer 6-11
                var isIE = /*@cc_on!@*/ false || !!document.documentMode;
                return isIE && largeDesktopView;
            }
            /**
             * Function for desktop view for browsers other than internet explorer.
             * */
            _largeDesktopViewOther(largeDesktopView) {
                // Internet Explorer 6-11
                var isIE = /*@cc_on!@*/ false || !!document.documentMode;
                return !isIE && largeDesktopView;
            }
            _getPaxList(index, arr) {
                return arr[index];
            }
            ready() {
                super.ready();
                this._closeIconIfAdultIsOnlyOne();
                var leadPaxInfo = this.onlyLeadPaxInfo;
                if (leadPaxInfo === true) {
                    this.adultPaxCount = 1;
                    this.childPaxCount = 0;
                }
                var adultPax = this.adultPaxCount;
                var childPax = this.childPaxCount;
                var totalPax = +adultPax + +childPax;
                var adultPaxCount1 = [];
                for (var i = 0; i < adultPax; i++) {
                    adultPaxCount1.push(i);
                }
                this.adultPaxCountArray = adultPaxCount1;
                var childPaxCount1 = [];
                for (var i = 0; i < childPax; i++) {
                    childPaxCount1.push(i);
                }
                this.childPaxCountArray = childPaxCount1;
                this._hideDashForMobileView();
                this._getAdultPaxList();
                this._getChildPaxList();
                this.travelerInfo = this;
                this.indexArray = [];
                this.indexArrayChild = [];
            }
        }

        window.customElements.define(TTravelerInfo.is, TTravelerInfo);
    </script>
</dom-module>