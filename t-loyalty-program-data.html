<link rel="import" href="../polymer/polymer-element.html">

<dom-module id="t-loyalty-program-data">
    <template>
        <style>
       :host {
        display: block;
      }

      paper-dropdown-menu {
        --paper-input-container-underline-focus: #4CB050;
        --paper-input-container-focus-color: #4CB050;
        --paper-input-container-label-focus: lightgray;
      }

      paper-input {
        --paper-input-container-underline-focus: #4CB050;
        --paper-input-container-focus-color: #4CB050;
        --paper-input-container-label-focus: lightgray;
      }

      @media (min-width: 320px) and (max-width:380px) {
       .guestName {
        width: 45%;
        margin-left: -5px;
      }

      .programName {
        width: 45%;
        margin-left: 11px;
      }

      .programNumber {
        width: 45%;
        margin-left: -5px;
      }

      #buttonRemove {
        margin-left: 10px;
        margin-top: 20px;
        width: 60px;
        color: var(--color-for-button-labels);
        font-weight: 450;
        text-transform: capitalize;
      }
      }
      
      @media (min-width: 380px) and (max-width:767px) {
      .guestName {
        width: 45%;
        margin-left: -5px;
      }

      .programName {
        width: 45%;
        margin-left: 11px;
      }

      .programNumber {
        width: 45%;
        margin-left: -5px;
      }

       #buttonRemove {
        margin-left: 15px;
        margin-top: 6%;
        width: 60px;
        color: var(--color-for-button-labels);
        font-weight: 450;
        text-transform: capitalize;
      }
      }

      @media (min-width: 768px) and (max-width:1023px) {
      .guestName {
        width: 22%;
      }

      .programName {
        width: 22%;
        margin-left: 10px;
      }

      .programNumber {
        width: 22%;
        margin-left: 10px;
      }
      #buttonRemove {
        margin-top: 5%;
        margin-left: 20px;
        width: 60px;
        color: var(--color-for-button-labels);
        font-weight: 450;
        text-transform: capitalize;
      }
      }

      @media (min-width: 1024px){
      .guestName {
        width: 21%;
        margin-left: 10px;
      }

      .programName {
        width: 21%;
        margin-left: 25px;
      }

      .programNumber {
        width: 21%;
        margin-left: 25px;
      }
       #buttonRemove {
        margin-top: 2%;
        margin-left: 65px;
        width: 60px;
        color: var(--color-for-button-labels);
        font-weight: 450;
        text-transform: capitalize;
      }
      }
      .guestName,
      .programName,
      .programNumber,
      #buttonRemove {
        float: left;
      }

      #guestNameError {
      font-size: var(--paper-font-caption_-_font-size);
                /* margin-top: -6px;
                margin-left: 1px;
                position: absolute; */
                color: var(--paper-deep-orange-a700);
      }
      .item {
        clear: both;
      }
    </style>

<div class="guestName" id="guestNameDiv">
    <paper-dropdown-menu label="{{_guestName}}" id="guestName{{loyaltyProgramNumber}}" on-blur="_isValid" on-tap="_updatePaxList" required auto-validate invalid="{{_guestNameInvalid}}">
        <paper-listbox slot="dropdown-content" selected="{{_guestNameValue}}">
            <template is="dom-repeat" items={{_tempPaxArray}}>
                <paper-item id="{{loyaltyProgramNumber}}" on-tap="_showGuestProgramDetails">{{item.firstName}}&nbsp{{item.lastName}}</paper-item>
            </template>
    </paper-listbox>
    </paper-dropdown-menu>
    <input is="iron-input" type="hidden" bind-value="[[_guestNameValue]]">
    <div id="guestNameError" hidden$="{{_showGuestNameError}}">{{_guestNameError}}</div>
    </div>
    <div hidden$="{{_showProgramNameInput}}">
        <paper-input label="{{_programName}}" id="programNameInput{{loyaltyProgramNumber}}" value="{{_programNameValue}}" invalid="{{_programNameInvalid}}" on-blur="_isValid" class="programName" required></paper-input>
    </div>
    <div hidden$="{{_showProgramNameDropdown}}">
        <paper-dropdown-menu label="{{_programName}}" id="programName{{loyaltyProgramNumber}}" invalid="{{_programNameInvalid}}" on-blur="_isValid" class="programName" required auto-validate>
            <paper-listbox slot="dropdown-content" selected="{{_programNameValue}}">
                <template is="dom-repeat" items={{paxList}}>
          <paper-item>{{item.membership.programName}}</paper-item>
        </template>
            </paper-listbox>
        </paper-dropdown-menu>
        <input is="iron-input" type="hidden" bind-value="[[_programNameValue]]">

    </div>
    <div>
        <paper-input label="{{_programNumber}}" id="programNumber{{loyaltyProgramNumber}}" value="{{_programNumberValue}}" invalid="{{_programNumberInvalid}}" class="programNumber" on-blur="_isValid" on-click="_showValidation" required auto-validate></paper-input>
    </div>
    <div id="buttonRemoveDiv" hidden$=[[_isRemoveButtonHidden]]>
        <paper-button id="buttonRemove" on-tap="_deleteLoyaltyProgram" class$="c{{loyaltyProgramNumber}}">{{_remove}}</paper-button>
    </div>
    </template>

    <script>
        /**
         * `t-loyalty-program-data`
         * 
         *
         * @customElement
         * @polymer
         * @demo demo/index.html
         */
        class TLoyaltyProgramData extends Polymer.Element {
            static get is() {
                return 't-loyalty-program-data';
            }
            static get properties() {
                return {
                    /**
                     * Used for paxlist
                     * */
                    paxList: {
                        type: Object,
                    },

                    /**
                     * This property set to false if paxlist is not available.
                     * */
                    paxListAvailable: {
                        type: Boolean
                    },
                    loyaltyProgramNumber: Number,
                    /**
                     * @private
                     * used for iron media query
                     * */
                    _smallMobileView: {
                        type: Boolean,
                        value: false
                    },
                    /**
                     * @private
                     * used for iron media query
                     * */
                    _mobileView: {
                        type: Boolean,
                        value: false
                    },
                    /**
                     * @private
                     * used for iron media query
                     * */
                    _tabletView: {
                        type: Boolean,
                        value: false
                    },
                    /**
                     * @private
                     * used for iron media query
                     * */
                    _desktopView: {
                        type: Boolean,
                        value: false
                    },
                    /**
                     * @private
                     * used for iron media query
                     * */
                    _largeDesktopView: {
                        type: Boolean,
                        value: false
                    },
                    /**
                     *@private
                     **/
                    _guestNameValue: String,
                    /**
                     *@private
                     **/
                    _programNameValue: String,
                    /**
                     *@private
                     **/
                    _programNumberValue: String,
                    /**
                     * @private
                     * To store temporary paxlist for dropdown.
                     * */
                    _tempPaxArray: {
                        type: Array,
                        value: []
                    },
                    _showGuestNameError: {
                        type: Boolean,
                        value: true
                    },
                    /**
                     * @private
                     * Property to hide remove button when loyalty program is only one.
                     * */
                    _isRemoveButtonHidden: {
                        type: Boolean,
                        computed: '_lessThanEqualToOne(tLoyaltyProgram._loyaltyPrograms.length , 1)'
                    },
                    /**
                     * @private
                     * This is true if paxlist is not available.
                     * */
                    _showProgramNameInput: {
                        type: Boolean,
                        value: true
                    },
                    /**
                     * @private
                     * This is true if paxlsit ia available.
                     * */
                    _showProgramNameDropdown: {
                        type: Boolean,
                        value: true
                    },
                    /**
                     * @private
                     * */
                    _guestNameInvalid: {
                        type: Boolean,
                        value: false
                    },
                    /**
                     * @private
                     * */
                    _programNameInvalid: {
                        type: Boolean,
                        value: false
                    },
                    /**
                     * @private
                     * */
                    _programNumberInvalid: {
                        type: Boolean,
                        value: false
                    },
                    _remove: String,
                    _guestNameError: String,
                    _guestName: String,
                    _programName: String,
                    _programNumber: String,
                };
            }
            ready() {
                super.ready();
                this._showProgramName();
                this._setDefaultRsourcesValue();
            }
            _setDefaultRsourcesValue() {
                    this._remove = this.resources.loyaltyProgram.remove ? this.resources.loyaltyProgram.remove : "Remove";
                    this._guestNameError = this.resources.loyaltyProgram.guestNameError ? this.resources.loyaltyProgram.guestNameError : "Please enter guest details first";
                    this._guestName = this.resources.loyaltyProgram.label.guestName ? this.resources.loyaltyProgram.label.guestName : "Guest name";
                    this._programName = this.resources.loyaltyProgram.label.programName ? this.resources.loyaltyProgram.label.programName : "Program name";
                    this._programNumber = this.resources.loyaltyProgram.label.programNumber ? this.resources.loyaltyProgram.label.programNumber : "Program number";
                }
                /**
                 * To set hidden property of remove button.
                 * */
            _lessThanEqualToOne(loyaltyProgramAdultLength, hiddenButtonAdultNumber) {
                    return loyaltyProgramAdultLength <= hiddenButtonAdultNumber;
                }
                /**
                 * Program name field if paxlist not given then paper-input.
                 * Program name field if paxlist is given then paper-dropdown-menu.
                 * */
            _showProgramName() {
                    if (this.paxListAvailable === false) {
                        this._showProgramNameInput = false;
                    } else {
                        this._showProgramNameDropdown = false;
                    }
                }
                /**
                 * To delet loyalty profram on click of button 'Remove'.
                 **/
            _deleteLoyaltyProgram(e) {
                var index = parseInt(e.currentTarget.className.replace("c", ""));
                if (index > -1) {
                    this.tLoyaltyProgram.splice('_loyaltyPrograms', index, 0);
                }
                var parent = this.parentElement.parentElement;
                parent.removeChild(this.parentElement);
                this.tLoyaltyProgram._deleteCount = this.tLoyaltyProgram._deleteCount + 1;

            }
            _isValid(e) {
                    var ind = this.loyaltyProgramNumber;
                    e.currentTarget.invalid = false;
                    this.tLoyaltyProgram._isValidLoyalty(ind, e, this._guestNameValue, this._programNameValue, this._programNumberValue);
                }
                /**
                 * Using this function on-tap of guest name.
                 * Set the program name and program number if paxlist is available.
                 * */
            _showGuestProgramDetails(e) {
                if (this.paxListAvailable != false) {
                    var paxIndex = e.model.index;
                    var paxListArray = this.paxList;
                    var programNameIndex = this.paxList.findIndex(x => x.membership == paxListArray[paxIndex].membership);
                    this._programNameValue = programNameIndex;
                    var programNumber = this.shadowRoot.querySelector("#programNumber" + e.currentTarget.id);
                    this._programNumberValue = paxListArray[paxIndex].membership.number;
                    this._guestNameInvalid = false;
                    this._programNameInvalid = false;
                    this._programNumberInvalid = false;
                } else {
                    var paxListArray = this._updatePaxList();
                }
                var ind = this.loyaltyProgramNumber;
                this.tLoyaltyProgram._loyaltyPrograms[ind].loyaltyProgram.guestName = paxListArray[e.model.index].firstName + ' ' + paxListArray[e.model.index].lastName;

            }
            _updatePaxList() {
                if (this.paxListAvailable === false) {
                    var paxInfo = this.guestInfo.isData();
                    var paxTempArray = [];
                    var prodLen = paxInfo.length;
                    for (var i = 0; i < prodLen; i++) {
                        var roomLen = paxInfo[i].length;
                        for (var j = 0; j < roomLen; j++) {
                            var paxLen = paxInfo[i][j].length;
                            for (var k = 0; k < paxLen; k++) {
                                if (paxInfo[i][j][k].firstName != null) {
                                    paxTempArray.push(paxInfo[i][j][k]);
                                }
                            }
                        }
                    }
                    var paxList = paxTempArray;
                    for (var i = 0; i < paxList.length; i++) {
                        for (var j = i + 1; j < paxList.length; j++) {
                            if (paxList[i].firstName === paxList[j].firstName &&
                                paxList[i].lastName === paxList[j].lastName) {
                                paxList.splice(j, 1);
                            }
                        }
                    }
                    this._tempPaxArray = paxList;
                } else {
                    this._tempPaxArray = this.paxList;
                }
                if (this._tempPaxArray.length === 0) {

                    this._showGuestNameError = false;
                    this._guestNameInvalid = true;
                    var len = this.tLoyaltyProgram._loyaltyPrograms.length;
                } else {
                    this._showGuestNameError = true;
                    this._guestNameInvalid = false;
                }
                return this._tempPaxArray;
            }

        }

        window.customElements.define(TLoyaltyProgramData.is, TLoyaltyProgramData);
    </script>
</dom-module>